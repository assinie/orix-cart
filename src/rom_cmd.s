; vim: set ft=asm6502-2 ts=8 et:
.feature loose_char_term, string_escapes, dollar_in_identifiers
.feature labels_without_colons


;----------------------------------------------------------------------
;
;----------------------------------------------------------------------
.setcpu "6502"

;----------------------------------------------------------------------
;                       cc65 includes
;----------------------------------------------------------------------
.include "telestrat.inc"

;----------------------------------------------------------------------
;                       Orix SDK includes
;----------------------------------------------------------------------
.include "SDK.mac"

;----------------------------------------------------------------------
;                       Application includes
;----------------------------------------------------------------------
.include "macros/rom_cmd.mac"

;----------------------------------------------------------------------
;                               Imports
;----------------------------------------------------------------------
.import PrintHexByte

;----------------------------------------------------------------------
;                               Exports
;----------------------------------------------------------------------

;----------------------------------------------------------------------
;                       Defines / Constants
;----------------------------------------------------------------------
twil_register := $0342
twil_bank     := $0343

;----------------------------------------------------------------------
;                               Zéro Page
;----------------------------------------------------------------------


;----------------------------------------------------------------------
;		                Strings
;----------------------------------------------------------------------
.pushseg
	.segment "RODATA"
                startup_message:
                        .asciiz "Starting rom..."

                hello_world:
                        .asciiz "Hello world!\r\n"

                bonjour_monde:
                        .asciiz "Bonjour le monde!\r\n"

                bank_id:
                        .asciiz "Bank $"
.popseg

;----------------------------------------------------------------------
; Définition de la rom
;----------------------------------------------------------------------
        ;----------------------------------------------------------------------
        ; Liste des commandes
        ;----------------------------------------------------------------------
        add_command "hello"
        add_command "bonjour"
        add_command "bankid"

        ;----------------------------------------------------------------------
        ; Vecteurs Orix: rom_type, parse_vector, rom_signature
        ;----------------------------------------------------------------------
        set_orix_vectors $01, $0000, "Dummy ROM"
        ; set_orix_vectors $01, $0000, rom_signature

        ;----------------------------------------------------------------------
        ; Vecteurs 6502: nmi, reset, irq
        ;----------------------------------------------------------------------
        set_cpu_vectors rom_start, rom_start, IRQVECTOR

        ;----------------------------------------------------------------------
        ; Signature de la rom
        ;----------------------------------------------------------------------
        ; rom_signature: .asciiz "Example ROM"


;----------------------------------------------------------------------
;                            Code de la rom
;----------------------------------------------------------------------
rom_start
        print startup_message
        rts

;----------------------------------------------------------------------
;
; Entrée:
;       AY: Adresse de la ligne de commande (A=LSB)
;       X : -
;
;----------------------------------------------------------------------
hello
        print hello_world
        rts

;----------------------------------------------------------------------
;
; Entrée:
;       AY: Adresse de la ligne de commande (A=LSB)
;       X : -
;
;----------------------------------------------------------------------
bonjour
        print bonjour_monde
        rts

;----------------------------------------------------------------------
;
; Entrée:
;       AY: Adresse de la ligne de commande (A=LSB)
;       X : -
;
;----------------------------------------------------------------------
bankid
        print bank_id

        lda twil_bank
        asl
        asl
        tsx
        pha

        lda VIA2::PRA
        and #$07
        clc
        adc $100,x
        sta $100,x

        lda twil_register
        and #$20
        adc $100,x

        jsr PrintHexByte
        crlf

        pla
        rts

