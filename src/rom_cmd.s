; vim: set ft=asm6502-2 ts=8 et:
.feature loose_char_term, string_escapes, dollar_in_identifiers
.feature labels_without_colons


;----------------------------------------------------------------------
;
;----------------------------------------------------------------------
.setcpu "6502"

;----------------------------------------------------------------------
;                       cc65 includes
;----------------------------------------------------------------------
.include "telestrat.inc"

;----------------------------------------------------------------------
;                       Orix SDK includes
;----------------------------------------------------------------------
.include "SDK.mac"

;----------------------------------------------------------------------
;                       Application includes
;----------------------------------------------------------------------
.include "macros/rom_cmd.mac"

;----------------------------------------------------------------------
;                               Imports
;----------------------------------------------------------------------

;----------------------------------------------------------------------
;                               Exports
;----------------------------------------------------------------------

;----------------------------------------------------------------------
;                       Defines / Constants
;----------------------------------------------------------------------
twil_register := $0342
twil_bank     := $0343

;----------------------------------------------------------------------
;                               Zéro Page
;----------------------------------------------------------------------


;----------------------------------------------------------------------
;		                Strings
;----------------------------------------------------------------------
.pushseg
	.segment "RODATA"
                startup_message:
                        .asciiz "Starting rom..."

                hello_world:
                        .asciiz "Hello world!\r\n"

                bonjour_monde:
                        .asciiz "Bonjour le monde!\r\n"

                bank_id:
                        .asciiz "Bank $"
.popseg

;----------------------------------------------------------------------
; Définition de la rom
;----------------------------------------------------------------------
        ;----------------------------------------------------------------------
        ; Liste des commandes
        ;----------------------------------------------------------------------
        add_command "hello"
        add_command "bonjour"
        add_command "bankid"

        ;----------------------------------------------------------------------
        ; Vecteurs Orix: rom_type, parse_vector, rom_signature
        ;----------------------------------------------------------------------
        set_orix_vectors $01, $0000, "Dummy ROM"
        ; set_orix_vectors $01, $0000, rom_signature

        ;----------------------------------------------------------------------
        ; Vecteurs 6502: nmi, reset, irq
        ;----------------------------------------------------------------------
        set_cpu_vectors rom_start, rom_start, IRQVECTOR

        ;----------------------------------------------------------------------
        ; Signature de la rom
        ;----------------------------------------------------------------------
        ; rom_signature: .asciiz "Example ROM"


;----------------------------------------------------------------------
;                            Code de la rom
;----------------------------------------------------------------------
.proc rom_start
                print startup_message
                rts
.endproc

;----------------------------------------------------------------------
;
; Entrée:
;       AY: Adresse de la ligne de commande (A=LSB)
;       X : -
;
;----------------------------------------------------------------------
.proc hello
                print hello_world
                rts
.endproc

;----------------------------------------------------------------------
;
; Entrée:
;       AY: Adresse de la ligne de commande (A=LSB)
;       X : -
;
;----------------------------------------------------------------------
.proc bonjour
                print bonjour_monde
                rts
.endproc

;----------------------------------------------------------------------
;
; Entrée:
;       AY: Adresse de la ligne de commande (A=LSB)
;       X : -
;
;----------------------------------------------------------------------
.proc bankid
                print bank_id

                lda twil_bank
                asl
                asl
                tsx
                pha

                lda VIA2::PRA
                and #$07
                clc
                adc $100,x
                sta $100,x

                lda twil_register
                and #$20
                adc $100,x

                jsr PrintHexByte
                crlf

                pla
                rts
.endproc

;----------------------------------------------------------------------
; Affiche la valeur de A en hexa
;
; Entrée:
;       A: valeur binaire
;
; Sortie:
;       A: modifié
;       X: inchangé
;       Y: inchangé
;----------------------------------------------------------------------
.proc PrintHexByte
                cmp #10
                bcc nibout

        hexout1:
                pha

                ; High nibble
                lsr
                lsr
                lsr
                lsr
                jsr nibout

                ; Low nibble
                pla
                and #$0f

        nibout:
                ora #$30
                cmp #$3a
                bcc nibo1
                adc #$06

        nibo1:
                cputc
                rts
.endproc
